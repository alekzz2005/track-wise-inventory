<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - TrackWise</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1>Inventory Management</h1>
                <p>{{ profile.company.name }} - TrackWise</p>
            </div>
            <div style="margin-left: auto;">
                <a href="{% url 'product_add' %}" class="btn btn-outline-header" style="width: auto; margin-right: 1rem;">+ Add Product</a>
                <a href="{% url 'logout' %}" class="btn btn-outline-logout" style="width: auto;">Logout</a>
            </div>
        </div>
        
        <div class="dashboard-nav">
            <nav style="display: flex; gap: 1rem;">
                <a href="{% url 'dashboard' %}" class="nav-inactive">Dashboard</a>
                <a href="{% url 'inventory_list' %}" class="nav-active">Inventory</a>
                <a href="#" class="nav-inactive">Reports</a>
                <a href="#" class="nav-inactive">Staff Management</a>
                <a href="#" class="nav-inactive">Company Settings</a>
            </nav>
        </div>
        
        <div class="dashboard-content">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
            
            <!-- Search and Filter Section -->
            <div class="content-card">
                <!-- <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0;">Products</h3>
                    <a href="{% url 'product_add' %}" class="btn btn-primary" style="width: auto;">
                        + Add Product
                    </a>
                </div> -->
                
                <form method="get" style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: end;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Search Products</label>
                        <input type="text" name="search" value="{{ search_query }}" class="form-control" placeholder="Search by name or category...">
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Sort by Cost</label>
                        <select name="cost_filter" class="form-control" onchange="this.form.submit()">
                            <option value="">Default</option>
                            <option value="low" {% if cost_filter == 'low' %}selected{% endif %}>Low to High</option>
                            <option value="high" {% if cost_filter == 'high' %}selected{% endif %}>High to Low</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-secondary" style="width: auto;">Apply</button>
                </form>
            </div>
            
            <!-- Products Grid -->
            <div class="products-grid">
                {% for product in products %}
                    <div class="product-card" onclick="window.location.href='{% url 'product_detail' product.pk %}'" style="cursor: pointer;">
                        <div class="product-image">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.item_name }}">
                            {% else %}
                                <div class="product-image-placeholder">
                                    <span>No Image</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="product-info">
                            <h4>{{ product.item_name }}</h4>
                            <p class="product-category">{{ product.get_category_display }}</p>
                            <p class="product-cost">₱{{ product.cost_price }} per {{ product.singular_unit }}</p>
                            
                            <div class="stock-controls">
                                <button class="btn-stock btn-decrease" onclick="event.stopPropagation(); decreaseStock({{ product.pk }})">-</button>
                                <span class="stock-quantity" id="quantity-{{ product.pk }}">{{ product.get_display_quantity }}</span>
                                <button class="btn-stock btn-increase" onclick="event.stopPropagation(); increaseStock({{ product.pk }})">+</button>
                            </div>
                            
                            <div class="product-value">
                                Total Value: ₱<span id="value-{{ product.pk }}">{{ product.total_value|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="content-card">
                        <p style="text-align: center; color: var(--secondary-color); padding: 2rem;">
                            No products found. <a href="{% url 'product_add' %}">Add your first product</a> to get started.
                        </p>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Should be under Reports
            {% if products %}
                <div class="content-card">
                    <h4>Inventory Summary</h4>
                    <p>Total Products: {{ products.count }}</p>
                    <p>Total Inventory Value: ₱{{ total_inventory_value|floatformat:2 }}</p>
                </div>
            {% endif %} -->
        </div>
    </div>

    <script>
        function increaseStock(productId) {
            fetch(`/inventory/${productId}/increase/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`quantity-${productId}`).textContent = data.display_quantity;
                    document.getElementById(`value-${productId}`).textContent = data.total_value.toFixed(2);
                }
            });
        }

        function decreaseStock(productId) {
            fetch(`/inventory/${productId}/decrease/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`quantity-${productId}`).textContent = data.display_quantity;
                    document.getElementById(`value-${productId}`).textContent = data.total_value.toFixed(2);
                }
            });
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>